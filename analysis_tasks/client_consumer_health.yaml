id: client_consumer_health
name: Client and Consumer Group Health Check
description: Analyze consumer groups, client connections, and consumption patterns
category: client

prompt: |
  Analyze Kafka consumer groups and client health.
  
  Admin/Consumer Group Data:
  {admin}
  
  Logs (for client errors):
  {logs}
  
  Comprehensive Consumer Group Analysis:
  
  1. CONSUMER LAG ANALYSIS:
     - Current lag per consumer group
     - Lag trends (increasing/decreasing)
     - Partitions with excessive lag
     - Stuck or inactive consumers
     - Calculate time to catch up at current rate
  
  2. CONSUMER GROUP STATE:
     - State of each group (Active/Rebalancing/Dead/Empty)
     - Rebalancing frequency
     - Partition assignment balance
     - Idle consumer instances
  
  3. CONSUMPTION PATTERNS:
     - Consumption rate vs production rate
     - Bursty vs steady consumption
     - Peak consumption times
     - Consumer efficiency
  
  4. CLIENT CONNECTION ISSUES:
     - Connection timeouts
     - Authentication failures
     - Network errors
     - Version incompatibilities
     - Client-side errors in logs
  
  5. REBALANCING ISSUES:
     - Frequent rebalancing (flapping)
     - Long rebalance times
     - Partition ownership changes
     - Session timeout issues
  
  6. CONSUMER CONFIGURATION:
     - Fetch sizes
     - Session timeouts
     - Heartbeat intervals
     - Max poll records
     - Auto-commit settings
  
  7. PROBLEMATIC PATTERNS:
     - Consumers not committing offsets
     - Groups with no active members
     - Overlapping consumer groups
     - Manual offset management issues
     - Poison messages causing failures
  
  8. QUOTA VIOLATIONS:
     - Consumer throttling
     - Quota exceeded errors
     - Rate limiting impacts
  
  For each consumer group provide:
  - Group ID and state
  - Number of members
  - Total lag
  - Lag per partition
  - Consumption rate
  - Issues identified
  
  Look for log patterns:
  - "Rebalancing"
  - "Session timeout"
  - "Offset commit failed"
  - "Heartbeat failed"
  - "Connection refused"
  - "Authentication failed"
  
  Format as JSON:
  {
    "findings": [{
      "title": "Consumer group health issues detected",
      "severity": "high",
      "description": "X consumer groups have problems",
      "consumer_groups": [
        {
          "group_id": "payment-processor",
          "state": "Rebalancing",
          "members": 3,
          "total_lag": 1000000,
          "issues": [
            "High lag on partition 5 (500K messages)",
            "Frequent rebalancing (10 times/hour)"
          ],
          "consumption_rate": "1000 msg/sec",
          "production_rate": "2000 msg/sec",
          "time_to_catchup": "Never at current rate"
        }
      ],
      "client_errors": [
        {
          "error": "Session timeout",
          "frequency": "50/hour",
          "affected_groups": ["group1", "group2"]
        }
      ],
      "impact": "Message processing delayed by hours",
      "root_cause": "Consumers cannot keep up with production rate",
      "remediation": "1. Add more consumer instances\n2. Increase fetch size\n3. Optimize processing logic"
    }]
  }

severity_keywords:
  "stuck consumer": "critical"
  "never catch up": "critical"
  "high lag": "high"
  "frequent rebalancing": "high"
  "session timeout": "medium"
  "inactive consumer": "high"
  "lag increasing": "high"

default_severity: high
enabled: true
